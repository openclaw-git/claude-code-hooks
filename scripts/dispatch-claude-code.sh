#!/usr/bin/env bash
# Dispatch Claude Code task with OpenClaw-friendly metadata layout.
# - No hardcoded gateway token
# - Supports concurrent tasks via task_id isolation

set -euo pipefail

usage(){
  cat <<'EOF'
Usage:
  dispatch-claude-code.sh -p "<prompt>" [options]

Options:
  -p, --prompt TEXT           Task prompt (required)
  -n, --name NAME             Task name (default: adhoc-<timestamp>)
  -w, --workdir DIR           Claude working directory (default: current dir)
  -c, --channel NAME          Notify channel (default: feishu)
  -t, --target ID             Notify target/chat id (optional)
  -s, --session KEY           Callback session key (optional)
      --result-root DIR       Result root (default: ~/.openclaw/claude-code-results)
      --task-id ID            Custom task id (default auto)
      --agent-teams           Enable Agent Teams
      --teammate-mode MODE    auto|in-process|tmux
      --permission-mode MODE  pass through to claude
      --allowed-tools TOOLS   pass through to claude
      --model MODEL           model override

Examples:
  dispatch-claude-code.sh -p "åˆ†æžä»“åº“å¹¶ç»™å‡ºé‡æž„æ–¹æ¡ˆ" -n "repo-audit" -c feishu -t "ou_xxx"
  dispatch-claude-code.sh -p "é‡æž„æµ‹è¯•" --agent-teams --teammate-mode auto
EOF
}

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
RUNNER="${CLAUDE_RUNNER:-$SCRIPT_DIR/claude_code_run.py}"

PROMPT=""
TASK_NAME=""
WORKDIR="$(pwd)"
CHANNEL="feishu"
TARGET=""
CALLBACK_SESSION=""
RESULT_ROOT="${OPENCLAW_HOOK_RESULT_ROOT:-$HOME/.openclaw/claude-code-results}"
TASK_ID=""
AGENT_TEAMS="0"
TEAMMATE_MODE=""
PERMISSION_MODE=""
ALLOWED_TOOLS=""
MODEL=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -p|--prompt) PROMPT="$2"; shift 2;;
    -n|--name) TASK_NAME="$2"; shift 2;;
    -w|--workdir) WORKDIR="$2"; shift 2;;
    -c|--channel) CHANNEL="$2"; shift 2;;
    -t|--target) TARGET="$2"; shift 2;;
    -s|--session) CALLBACK_SESSION="$2"; shift 2;;
    --result-root) RESULT_ROOT="$2"; shift 2;;
    --task-id) TASK_ID="$2"; shift 2;;
    --agent-teams) AGENT_TEAMS="1"; shift;;
    --teammate-mode) TEAMMATE_MODE="$2"; shift 2;;
    --permission-mode) PERMISSION_MODE="$2"; shift 2;;
    --allowed-tools) ALLOWED_TOOLS="$2"; shift 2;;
    --model) MODEL="$2"; shift 2;;
    -h|--help) usage; exit 0;;
    *) echo "Unknown option: $1" >&2; usage; exit 1;;
  esac
done

if [ -z "$PROMPT" ]; then
  echo "Error: --prompt is required" >&2
  usage
  exit 1
fi

if [ -z "$TASK_NAME" ]; then
  TASK_NAME="adhoc-$(date +%Y%m%d_%H%M%S)"
fi
if [ -z "$TASK_ID" ]; then
  if command -v uuidgen >/dev/null 2>&1; then
    TASK_ID="$(uuidgen | tr '[:upper:]' '[:lower:]')"
  else
    TASK_ID="$(date +%s)-$$"
  fi
fi

TASK_DIR="$RESULT_ROOT/tasks/$TASK_ID"
META_FILE="$TASK_DIR/meta.json"
OUTPUT_FILE="$TASK_DIR/output.log"
mkdir -p "$TASK_DIR"

jq -n \
  --arg task_id "$TASK_ID" \
  --arg task_name "$TASK_NAME" \
  --arg prompt "$PROMPT" \
  --arg workdir "$WORKDIR" \
  --arg callback_session "$CALLBACK_SESSION" \
  --arg channel "$CHANNEL" \
  --arg target "$TARGET" \
  --arg started_at "$(date -Iseconds)" \
  --argjson agent_teams "$AGENT_TEAMS" \
  '{task_id:$task_id,task_name:$task_name,prompt:$prompt,workdir:$workdir,callback_session:$callback_session,notify:{channel:$channel,target:$target},agent_teams:($agent_teams==1),status:"running",started_at:$started_at}' \
  > "$META_FILE"

# Make hook context explicit; no hardcoded OPENCLAW_GATEWAY_TOKEN here
export OPENCLAW_HOOK_RESULT_ROOT="$RESULT_ROOT"
export OPENCLAW_HOOK_TASK_ID="$TASK_ID"

CMD=(python3 "$RUNNER" -p "$PROMPT" --cwd "$WORKDIR")
[ -n "$PERMISSION_MODE" ] && CMD+=(--permission-mode "$PERMISSION_MODE")
[ -n "$ALLOWED_TOOLS" ] && CMD+=(--allowedTools "$ALLOWED_TOOLS")
[ "$AGENT_TEAMS" = "1" ] && CMD+=(--agent-teams)
[ -n "$TEAMMATE_MODE" ] && CMD+=(--teammate-mode "$TEAMMATE_MODE")
[ -n "$MODEL" ] && export ANTHROPIC_MODEL="$MODEL"

echo "ðŸš€ Dispatch Claude Code"
echo "   task_id:   $TASK_ID"
echo "   task_name: $TASK_NAME"
echo "   workdir:   $WORKDIR"
echo "   notify:    ${CHANNEL}:${TARGET:-<none>}"
echo

"${CMD[@]}" 2>&1 | tee "$OUTPUT_FILE"
EXIT_CODE=${PIPESTATUS[0]}

jq --arg ts "$(date -Iseconds)" --arg code "$EXIT_CODE" '. + {completed_at:$ts, exit_code:($code|tonumber), status:"done"}' "$META_FILE" >"${META_FILE}.tmp"
mv "${META_FILE}.tmp" "$META_FILE"

echo
echo "âœ… finished: exit_code=$EXIT_CODE"
echo "   meta:   $META_FILE"
echo "   output: $OUTPUT_FILE"
echo "   result: $TASK_DIR/result.json (generated by hook)"

exit "$EXIT_CODE"
